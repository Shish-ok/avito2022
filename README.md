# Тестовое задание на позицию стажёра-бэкендера
## Микросервис для работы с балансом пользователей

Этот API микросевис на Go предоставляет возможность работы с балансом пользователей: поплнение баланса, снятие и перевод денег, резервирование средств, предоставление отчёта о всех транзакциях пользователя

## Вопросы и их решение

### Введение новых полей у методов для дополнительных заданий
Для более информативного составления бугалтерского отчёта я ввёл поле с названием услуги, id которой передаётся в методе резервации средст. Это рассширило схему таблицы для бугалтерского отчёта, сделав по итогу конечный csv файл удобным для работы бугалтерии. Также введённое поле было необходимо для реализации метода получения списка траназкций пользователя

### Алгоритм пагинации
Для погинации и сортировки пользовательских транзакций по времени и стоимости я ввёл два индекса, связав соответсвующие поля схемы с id транзакции в таблице с историей всех пользоательских транзакций. Затем пользуясь курсорной пагинацией выбирал по 5 транзакций для отображения на одной странице. В sql-запросе вместо offset сравнивал ключевые значения, используя кортежи.

### Разрезервирование средств
Создал end-point, принимающий id заказа ивозвращающий по нему средства пользователю

## Запустим локально при помощи Docker

```
docker build . -t go-api
docker-compose build
docker-compose up
```

## Описание запросов
Для выполнения запросов использовал swagger:
http://localhost:8080/swagger/index.html#/sales

### /balance
1. get_balance
  - POST http://localhost:8080/api/v1/balance/get_balance
  - Принимает JSON вида:
  ```
  {
    "id":0
  }
  ```
  - По id пользователя возращает его баланс
2. up_balance
  - POST http://localhost:8080/api/v1/balance/up_balance
  - Принимает JSON вида
  ```
  {
    "replenishment": 0, 
    "user_id": 0
  }
  ```
  - Пополняет баланс пользователя или создаёт его, если пользователь новый
3. transfer_money
  - POST http://localhost:8080/api/v1/balance/transfer_money
  - Принимает JSON вида
  ```
  {
    "cost": 0,
    "recipient_id": 0,
    "recipient_name": "string",
    "sender_id": 0,
    "sender_name": "string"
  }
  ```
  - Списывает деньги у одного человека и переводит их к другому
 4. withdraw_money
  - POST http://localhost:8080/api/v1/balance/withdraw_money
  - Принимает JSON вида
  ```
  {
    "debit_cost": 0,
    "user_id": 0
  }
  ```
  - Списывает деньги со счёта пользователя 

### /sales
5. reserve_money
  - POST http://localhost:8080/api/v1/sales/reserve_money
  - Принимает JSON вида
  ```
  {
    "cost": 0,
    "order_id": 0,
    "service_id": 0,
    "service_name": "string",
    "user_id": 0
  }
  ```
  - Резервирует средства с баланса пользователя на отдельный счёт
 6. return_money
  - POST http://localhost:8080/api/v1/sales/return_money
  - Принимает JSON вида
   ```
  {
    "order_id": 0
  }
  ```
  - По id заказа возвращает деньги пользователю на счёт
7. revenue_money
  - POST http://localhost:8080/api/v1/sales/revenue_money
  - Принимает JSON вида
   ```
  {
    "cost": 0,
    "order_id": 0,
    "service_id": 0,
    "service_name": "string",
    "user_id": 0
  }
  ```
  - Метод подтверждает операцию покупку и списывает деньги из холдера

## /accounting
8. report_link
  - POST http://localhost:8080/api/v1/accounting/report_link
  - Принимает JSON вида
   ```
  {
    "date": "2022-15"
  }
  ```
  - Генерирует csv-файл с отчётом для бугхалтерии. А также создаёт ссылку на него. В начала каждого файла для удоства стоит месяц, за который в данном файле отчёт
9. /:file_name
  - GET http://localhost:8080/api/v1/accounting/:file_name
  - Запрос на скачивание отчёта об общих доходах за месяц

## /user_transaction
10. cost_sort
  - GET http://localhost:8080/api/v1/user_transaction/cost_sort
  - Принимате на вход параметры из url:
    - increase (true/false) — true говорит о сортировке по возрастании, а false свидетельствует об сортировке по убыванию
    - user_id — id пользователя, по траназкциям которого производится сортировка
    - cursor — захешированная структура, хранящая данные для сортировки и перехода на следующий странцы пагинаци
11. time_sort
  - GET http://localhost:8080/api/v1/user_transaction/time_sort
  - Тот же самый набор данных, что и для /cost_sort

## Подведение итогов
- Мною был релизован минимальный необходимый функционал
- Удалось выполнить два плюса: реализован метод разрезервирования средств и есть swagger файл
- Выполнены 2 дополнительных задания
